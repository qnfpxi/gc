# 🧪 端到端测试手册

## 📋 测试前准备

### 1. 环境配置检查
```bash
# 检查 .env 文件
cat .env | grep TELEGRAM_BOT_TOKEN
# 应该显示您的真实 Bot Token

# 启动测试环境
./start_e2e_env.sh
```

### 2. 运行自动化测试
```bash
# 运行端到端自动测试
python test_e2e.py
# 确保所有测试都通过
```

## 🎯 测试用例 1：完美路径 (Happy Path)

### 步骤 1：启动 Bot
```bash
python test_bot.py
```

### 步骤 2：Telegram 交互测试

#### 2.1 用户认证
- [ ] 在 Telegram 中找到您的 Bot
- [ ] 发送 `/start` 命令
- [ ] **预期结果**: 收到欢迎消息，显示主菜单按钮
- [ ] **验证点**: 消息应包含用户名和四个主要按钮

#### 2.2 开始创建广告
- [ ] 点击 "📝 发布广告" 按钮
- [ ] **预期结果**: 显示分类选择界面
- [ ] **验证点**: 可以看到分类选项列表

#### 2.3 选择分类
- [ ] 选择任意一个分类
- [ ] **预期结果**: 跳转到标题输入界面
- [ ] **验证点**: 显示 "请输入广告标题" 提示

#### 2.4 输入标题
- [ ] 输入测试标题: "测试商品 iPhone 14 Pro"
- [ ] **预期结果**: 跳转到描述输入界面
- [ ] **验证点**: 显示 "请输入详细描述" 提示

#### 2.5 输入描述
- [ ] 输入测试描述: "这是一个端到端测试用的商品描述，包含详细信息。九成新，功能正常，配件齐全。"
- [ ] **预期结果**: 跳转到价格输入界面
- [ ] **验证点**: 显示价格输入提示和"面议"按钮

#### 2.6 设置价格
- [ ] 输入价格: "8888"
- [ ] **预期结果**: 跳转到图片上传界面
- [ ] **验证点**: 显示图片上传提示和"跳过图片"按钮

#### 2.7 上传图片
- [ ] 发送一张图片（任意图片）
- [ ] **预期结果**: 显示 "📤 正在上传图片，请稍候..." 然后显示上传成功
- [ ] **验证点**: 消息显示 "✅ 图片上传成功！(1/5)"，并提供继续添加或完成的选项

#### 2.8 完成图片上传
- [ ] 点击 "✅ 图片完成" 按钮
- [ ] **预期结果**: 跳转到位置分享界面
- [ ] **验证点**: 显示位置分享按钮和跳过选项

#### 2.9 分享位置
- [ ] 点击 "📍 分享位置" 按钮
- [ ] 在 Telegram 中选择并发送您的当前位置
- [ ] **预期结果**: 显示位置已保存，跳转到联系方式设置
- [ ] **验证点**: 显示联系方式选择选项

#### 2.10 设置联系方式
- [ ] 点击 "📱 使用 Telegram" 按钮
- [ ] **预期结果**: 跳转到最终确认界面
- [ ] **验证点**: 显示完整的广告预览信息

#### 2.11 确认发布
- [ ] 检查预览信息是否正确
- [ ] 点击 "✅ 确认发布" 按钮
- [ ] **预期结果**: 显示 "🚀 正在发布广告..." 然后显示发布成功
- [ ] **验证点**: 收到 "🎉 广告发布成功！" 消息，包含广告ID

### 步骤 3：后台验证

#### 3.1 数据库验证
```bash
# 连接数据库查看记录
docker compose exec postgres psql -U postgres -d telegram_bot_db

# 查询最新的广告记录
SELECT id, title, description, price, category_id, 
       ST_X(location::geometry) as longitude, 
       ST_Y(location::geometry) as latitude,
       images, contact_telegram, created_at 
FROM ads 
ORDER BY created_at DESC 
LIMIT 1;

# 退出数据库
\q
```

**验证点检查清单**:
- [ ] 记录存在且ID正确
- [ ] 标题内容正确
- [ ] 价格为 8888.00
- [ ] 位置坐标不为空
- [ ] images 字段包含图片URL
- [ ] contact_telegram 包含用户信息

#### 3.2 文件系统验证
```bash
# 检查上传的图片是否存在
ls -la storage/media/
ls -la storage/uploads/

# 应该能看到以日期命名的目录和图片文件
```

#### 3.3 API 验证
```bash
# 测试图片URL访问
curl -I http://localhost:8000/media/uploads/YYYY/MM/DD/xxxxx.jpg
# 应该返回 200 OK

# 测试广告查询API
curl "http://localhost:8000/api/v1/ads/" | jq
# 应该能看到刚刚创建的广告
```

## 🧪 测试用例 2：中途取消

### 步骤
- [ ] 开始创建广告流程
- [ ] 在输入标题后，发送 `/start` 命令
- [ ] **预期结果**: 流程重置，返回主菜单
- [ ] **验证**: 数据库中没有未完成的记录

## 🧪 测试用例 3：输入验证

### 3.1 价格验证
- [ ] 在价格输入步骤，输入 "abc"
- [ ] **预期结果**: 收到错误提示，要求重新输入
- [ ] **验证**: Bot 不崩溃，流程继续

### 3.2 图片格式验证
- [ ] 在图片上传步骤，发送文本文件
- [ ] **预期结果**: 收到格式错误提示或被忽略
- [ ] **验证**: 流程可以继续进行

## 📊 测试结果记录

### 系统环境
- **测试日期**: 
- **Python版本**: 
- **Docker版本**: 
- **数据库版本**: 

### 测试结果
| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 环境启动 | ⬜ | |
| 自动化测试 | ⬜ | |
| 完美路径 | ⬜ | |
| 中途取消 | ⬜ | |
| 输入验证 | ⬜ | |

### 发现的问题
1. 
2. 
3. 

### 性能观察
- **响应时间**: 
- **图片上传速度**: 
- **数据库写入时间**: 

## 🔧 故障排除

### 常见问题
1. **Bot 无响应**
   ```bash
   # 检查Bot进程
   ps aux | grep python
   # 检查网络连接
   curl https://api.telegram.org/
   ```

2. **图片上传失败**
   ```bash
   # 检查存储目录权限
   ls -la storage/
   # 检查API日志
   docker compose logs api
   ```

3. **数据库连接失败**
   ```bash
   # 检查数据库状态
   docker compose ps postgres
   # 检查数据库日志
   docker compose logs postgres
   ```

## ✅ 测试完成标志

当以下条件都满足时，端到端测试算完成：
- [ ] 所有自动化测试通过
- [ ] 完美路径手动测试成功
- [ ] 数据正确写入数据库
- [ ] 图片正确上传和访问
- [ ] 错误情况处理正常
- [ ] 性能表现可接受

**测试签名**: _______________ **日期**: ___________