# NiubiAI Bot - 网络错误修复指南

## 概述

本指南提供了修复NiubiAI Bot网络连接错误的方法，特别是针对日志中出现的`httpx.ReadError`错误。这些错误通常是由网络连接问题、超时设置不合理或者依赖包版本问题导致的。

## 修复步骤

### 1. 使用自动修复脚本

我们提供了一个自动修复脚本，可以帮助您快速解决大多数网络连接问题：

```bash
# 在本地执行以下命令，将修复脚本上传到服务器并执行
./fix_network_error_deploy.sh
```

这个脚本会执行以下操作：

- 检查服务器网络连接状态
- 更新关键依赖包（httpx和python-telegram-bot）
- 修改请求超时设置
- 添加重试机制
- 检查DNS设置
- 重启应用（可选）

### 2. 手动修复步骤

如果自动修复脚本无法解决问题，您可以尝试以下手动步骤：

#### 2.1 检查网络连接

```bash
sshpass -p "密码" ssh -o StrictHostKeyChecking=no root@服务器IP "ping -c 3 api.telegram.org"
```

#### 2.2 更新依赖包

```bash
sshpass -p "密码" ssh -o StrictHostKeyChecking=no root@服务器IP "cd /opt/niubiai && pip3 install --upgrade httpx python-telegram-bot"
```

#### 2.3 修改超时设置

检查并修改服务文件中的超时设置，将较短的超时时间（如5秒）增加到更长的时间（如30秒）。

#### 2.4 添加重试机制

在关键的网络请求函数中添加重试逻辑，以便在网络暂时不稳定时自动重试。

#### 2.5 重启应用

```bash
sshpass -p "密码" ssh -o StrictHostKeyChecking=no root@服务器IP "cd /opt/niubiai && pkill -f 'python3 main.py' && nohup python3 main.py > /dev/null 2>&1 &"
```

## 常见问题解决

### 问题1: 持续出现网络错误

如果修复后仍然出现网络错误，可能是由于：

- 服务器网络环境不稳定
- 防火墙阻止了外部连接
- API服务（如Telegram API）暂时不可用

**解决方案**：
- 检查服务器防火墙设置
- 考虑使用代理服务
- 增加更多的重试和更长的超时时间

### 问题2: 应用启动后立即崩溃

如果应用启动后立即崩溃，可能是由于：

- 依赖包版本冲突
- 配置文件错误
- 权限问题

**解决方案**：
- 检查日志文件获取详细错误信息
- 验证所有配置文件的正确性
- 确保应用目录有正确的权限

## 预防措施

为了减少网络错误的发生，建议采取以下预防措施：

1. 定期更新依赖包
2. 在代码中添加适当的错误处理和重试机制
3. 使用更可靠的网络环境或考虑使用代理
4. 实施监控系统，及时发现并解决问题

## 联系支持

如果您在修复网络错误时遇到任何问题，请联系技术支持团队获取帮助。